<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Profile Go micro-services in Kubernetes with pprof &#183; Rodrigo Dumont</title><meta name=description content="One of Go's most life-saving features is its native profiling tool, pprof. It enables you to instrument your code in order to discover problems related to performance, concurrency and memory usage.
I've read a few articles on how to set up the instrumentation, run the tool and analyze its results, but the examples usually work on your machine. Using it on code that is deployed on a Kubernetes cluster takes a few more steps, and this is how I did it."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.62.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Profile Go micro-services in Kubernetes with pprof"><meta property="og:description" content="One of Go's most life-saving features is its native profiling tool, pprof. It enables you to instrument your code in order to discover problems related to performance, concurrency and memory usage.
I've read a few articles on how to set up the instrumentation, run the tool and analyze its results, but the examples usually work on your machine. Using it on code that is deployed on a Kubernetes cluster takes a few more steps, and this is how I did it."><meta property="og:type" content="article"><meta property="og:url" content="http://rodrigodumont.com/2017/11/10/profile-go-micro-services-in-kubernetes-with-pprof/"><link rel=stylesheet href=http://rodrigodumont.com/dist/site.css><link rel=stylesheet href=http://rodrigodumont.com/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-42693325-1','auto');ga('send','pageview');}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a title="Rodrigo Dumont" href=http://rodrigodumont.com/>Rodrigo Dumont</a></h1><a class=button-square href=http://rodrigodumont.com/index.xml><i class="fa fa-rss"></i></a><a class="button-square button-social hint--top" data-hint=Twitter title=Twitter href=https://twitter.com/rlsdumont rel=me><i class="fa fa-twitter"></i></a><a class="button-square button-social hint--top" data-hint=Gitlab title=Gitlab href=https://gitlab.com/rdumont rel=me><i class="fa fa-gitlab"></i></a><a class="button-square button-social hint--top" data-hint=Github title=Github href=https://github.com/rdumont rel=me><i class="fa fa-github-alt"></i></a><a class="button-square button-social hint--top" data-hint="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/186760/rdumont rel=me><i class="fa fa-stack-overflow"></i></a><a class="button-square button-social hint--top" data-hint=LinkedIn title=LinkedIn href=https://linkedin.com/in/rdumont rel=me><i class="fa fa-linkedin"></i></a><a class="button-square button-social hint--top" data-hint=Email title=Email href=mailto:hi@rodrigodumont.com><i class="fa fa-envelope"></i></a></div><ul class=site-nav><li class=site-nav-item><a title=Blog href=/>Blog</a></li><li class=site-nav-item><a title=Projects href=/page/projects>Projects</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Profile Go micro-services in Kubernetes with pprof</h1><p class="post-date post-line"><span>Published <time datetime=2017-11-10 itemprop=datePublished>Fri, Nov 10, 2017</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/rdumont itemprop=url rel=author>Rodrigo Dumont</a></span></span></p></header><div class="post-content clearfix" itemprop=articleBody><p>One of Go's most life-saving features is its native profiling tool, <code>pprof</code>. It enables you to <strong>instrument your code</strong> in order to discover problems related to <strong>performance, concurrency and memory usage</strong>.</p><p>I've read a few articles on how to set up the instrumentation, run the tool and analyze its results, but the examples usually work on your machine. Using it on code that is <strong>deployed on a Kubernetes cluster</strong> takes a few more steps, and this is how I did it.</p><h2 id=instrumentation>Instrumentation</h2><p>The first thing is to reference <code>net/http/pprof</code>, usually in my <code>main.go</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;net/http&#34;</span>
    <span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;net/http/pprof&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>serveHTTP</span>)
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#66d9ef>nil</span>)
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>serveHTTP</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;Hello, world&#34;</span>))
}
</code></pre></div><p>The above code, by importing <code>net/http/pprof</code>, registers a few profiling endpoints to the default HTTP mux. Unfortunately that is probably not what most of us use in production. So instead, I set up the router to handle every request to <code>/debug/*</code> by redirecting it to the default mux. Below are a few options, depending on the router.</p><h3 id=http-serve-mux>HTTP serve mux</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewServeMux</span>()
    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>serveHTTP</span>)

    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/debug/&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultServeMux</span>)
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#a6e22e>r</span>)
}
</code></pre></div><h3 id=gorillamuxhttpsgithubcomgorillamux><a href=https://github.com/gorilla/mux>gorilla/mux</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>NewRouter</span>()
    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>serveHTTP</span>)

    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/debug/&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultServeMux</span>)
    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#a6e22e>r</span>)
}
</code></pre></div><h3 id=ginhttpsgithubcomgin-gonicgin><a href=https://github.com/gin-gonic/gin>Gin</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>New</span>()
	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>serveHTTP</span>)

	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Any</span>(<span style=color:#e6db74>&#34;/debug/*path&#34;</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>WrapH</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultServeMux</span>))

	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#a6e22e>r</span>)
}
</code></pre></div><p>The same concept could be used for other routers.</p><h2 id=web-interface>Web interface</h2><p>This first method of profiling gives us a web page, accessible through a browser, with a snapshot of some key items about the current Go program. In order to access it, I'm going to <strong>forward a port</strong><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> from the pod to my machine.</p><ol><li><code>kubectl get pods</code> provides me with a list of all pods in order to find the desired name</li><li><code>kubectl port-forward &lt;pod_name> &lt;local_port>:&lt;container_port></code> allows me to access <code>local_port</code> being forwarded to the pod's <code>container_port</code></li></ol><p>Now I'm able to go to <code>http://localhost:&lt;local_port>/debug/pprof/</code> on my web browser to see something that looks like the following:</p><pre><code>/debug/pprof/

profiles:
0	block
4	goroutine
2	heap
0	mutex
7	threadcreate

full goroutine stack dump
</code></pre><p>By clicking any of the profiles, you're taken to a detailed view of each of them. This is nice to get a quick overview of what's going on and might show you, for instance, deadlocks and growing goroutine count. But for the most powerful visualization I like to use <code>go tool pprof instead</code>.</p><h2 id=command-line-interface>Command line interface</h2><p>The purpose of this article is to show you how to put together everything that you might need to profile in production inside of a Kubernetes cluster, so I won't go into too much detail about <code>pprof</code> itself. The official documentation and release post provide plenty of examples of how to use the tool. <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><ol><li><p>Retrieve the binary (just skip to the next step if you already have it)</p><pre><code>kubectl cp &lt;pod_name&gt;:&lt;binary_path_in_pod&gt; &lt;local_binary_path&gt;
</code></pre></li><li><p>Run <code>pprof</code></p><pre><code># Get a 30 second CPU profile
go tool pprof &lt;local_binary_path&gt; 'http://localhost:&lt;local_port&gt;/debug/pprof/profile'

# Get a 60 second CPU profile
go tool pprof &lt;local_binary_path&gt; 'http://localhost:&lt;local_port&gt;/debug/pprof/profile?seconds=60'

# Get a heap profile
go tool pprof &lt;local_binary_path&gt; 'http://localhost:&lt;local_port&gt;/debug/pprof/heap'
</code></pre></li></ol><p>After running the command, it will go into an interactive mode with various options. I recommend you type <code>help</code> to find out what they are and to see the tool's online reference.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/>Use Port Forwarding to Access Applications in a Cluster</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://golang.org/src/net/http/pprof/pprof.go><code>net/http/pprof</code> Godoc</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://blog.golang.org/2011/06/profiling-go-programs.html>Profiling Go Programs</a>. 24 June 2011. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/tags/go/>go</a>,
<a href=/tags/pprof/>pprof</a>,
<a href=/tags/kubernetes/>kubernetes</a>,
<a href=/tags/gin/>gin</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Profile%20Go%20micro-services%20in%20Kubernetes%20with%20pprof&url=http%3a%2f%2frodrigodumont.com%2f2017%2f11%2f10%2fprofile-go-micro-services-in-kubernetes-with-pprof%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i><span class=hidden>Twitter</span></a>
<a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2frodrigodumont.com%2f2017%2f11%2f10%2fprofile-go-micro-services-in-kubernetes-with-pprof%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i><span class=hidden>Facebook</span></a>
<a class=icon-google-plus href="https://plus.google.com/share?url=http%3a%2f%2frodrigodumont.com%2f2017%2f11%2f10%2fprofile-go-micro-services-in-kubernetes-with-pprof%2f" onclick="window.open(this.href,'google-plus-share','width=490,height=530');return false;"><i class="fa fa-google-plus"></i><span class=hidden>Google+</span></a>
<a class=icon-linkedin href="https://www.linkedin.com/shareArticle?mini=true&title=Profile%20Go%20micro-services%20in%20Kubernetes%20with%20pprof&url=http%3a%2f%2frodrigodumont.com%2f2017%2f11%2f10%2fprofile-go-micro-services-in-kubernetes-with-pprof%2f&summary=" onclick="window.open(this.href,'linkedin-share','width=554,height=481');return false;"><i class="fa fa-linkedin"></i><span class=hidden>LinkedIn</span></a></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"rodrigodumont"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title="Rodrigo Dumont" href=http://rodrigodumont.com/>Rodrigo Dumont</a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-up"></i></a></div><p class=footer-copyright><span>&copy; 2017 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=http://rodrigodumont.com/js/jquery-1.11.3.min.js></script><script src=http://rodrigodumont.com/js/jquery.fitvids.js></script><script src=http://rodrigodumont.com/js/scripts.js></script></body></html>